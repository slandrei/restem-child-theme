name: Increment Build Number

on:
  push:
    branches:
      - main  # Change to 'master' if your branch uses that name

jobs:
  bump-build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Increment Build Pattern
        run: |
          # 1. Get the current Version line from style.css
          FULL_LINE=$(grep -i "Version:" style.css)
          echo "Original line: $FULL_LINE"

          # 2. Extract Base Version (stops before the first dash)
          # Example: '1.034-build-5' becomes '1.034'
          BASE_VER=$(echo "$FULL_LINE" | sed -E 's/Version:[[:space:]]*//I' | cut -d'-' -f1 | tr -d '[:space:]')

          # 3. Extract Current Build Number (finds number after 'build-')
          # If no build exists, defaults to 0
          CURRENT_BUILD=$(echo "$FULL_LINE" | grep -oP 'build-\K\d+' || echo "0")

          # 4. Increment and create new string
          NEW_BUILD=$((CURRENT_BUILD + 1))
          NEW_VERSION_STRING="$BASE_VER-build-$NEW_BUILD"

          # 5. Update the file
          sed -i "s/Version:.*/Version: $NEW_VERSION_STRING/g" style.css
          
          echo "Updated to: $NEW_VERSION_STRING"
          echo "NEW_VERSION=$NEW_VERSION_STRING" >> $GITHUB_ENV

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add style.css
          # [skip ci] prevents the action from triggering itself in a loop
          git commit -m "chore: increment build to ${{ env.NEW_VERSION }} [skip ci]"
          git push